---
title: "COVID 19 in Indonesia"
author: "By: Oliver Vieri"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```
***
```{r, echo=FALSE}
library(tidyverse)
library(fpp3)
library(lubridate)
library(kableExtra)
library(plotly)
library(DT)
library(broom)
library(pander)
library(mgcv)
library(Metrics)
library(splines)
```
<br>
<br>
```{r, echo=FALSE}
covid_deaths <- read_csv("https://data.humdata.org/hxlproxy/api/data-preview.csv?url=https%3A%2F%2Fraw.githubusercontent.com%2FCSSEGISandData%2FCOVID-19%2Fmaster%2Fcsse_covid_19_data%2Fcsse_covid_19_time_series%2Ftime_series_covid19_deaths_global.csv&filename=time_series_covid19_deaths_global.csv") %>%  filter(`Country/Region` == "Indonesia") %>% select(-`Province/State`, -Lat, -Long) %>%
  pivot_longer(cols=c(-1), names_to = "date") %>% mutate(date=mdy(date), daily_deaths=difference(value)) %>% rename("deaths"='value')

covid_confirmed <- read_csv("https://data.humdata.org/hxlproxy/api/data-preview.csv?url=https%3A%2F%2Fraw.githubusercontent.com%2FCSSEGISandData%2FCOVID-19%2Fmaster%2Fcsse_covid_19_data%2Fcsse_covid_19_time_series%2Ftime_series_covid19_confirmed_global.csv&filename=time_series_covid19_confirmed_global.csv") %>%  filter(`Country/Region` == "Indonesia") %>% select(-`Province/State`, -Lat, -Long) %>%
  pivot_longer(cols=c(-1), names_to = "date") %>% mutate(date=mdy(date), incidence=difference(value)) %>% rename("total"='value')

covid_recovered <- read_csv("https://data.humdata.org/hxlproxy/api/data-preview.csv?url=https%3A%2F%2Fraw.githubusercontent.com%2FCSSEGISandData%2FCOVID-19%2Fmaster%2Fcsse_covid_19_data%2Fcsse_covid_19_time_series%2Ftime_series_covid19_recovered_global.csv&filename=time_series_covid19_recovered_global.csv") %>%  filter(`Country/Region` == "Indonesia") %>% select(-`Province/State`, -Lat, -Long) %>%
  pivot_longer(cols=c(-1), names_to = "date") %>% mutate(date=mdy(date), daily_recovery=difference(value)) %>% rename("recovered"='value')

covid_id <- full_join(covid_confirmed, covid_deaths, by=c("date", "Country/Region")) %>% full_join(covid_recovered, by=c("date", "Country/Region")) %>% filter(date >= as.Date("2020-02-23")) %>% mutate(active_cases=total-deaths-recovered, closed_cases=deaths+recovered)
```


## Data and Records
<br>
Latest recorded COVID-19 case in Indonesia: <br>
```{r}
covid_id[-1] %>% filter(date == last(date)) %>% mutate(death_rate=deaths/total*100, recovery_rate=recovered/total*100) -> today_case
pander(today_case[,1:7])
pander(today_case[,8:11])
```
<br>
<ul>
Metrics used: 
<li>date: Date of the record</li>
<li>total: Total number of confirmed cases, active and closed</li>
<li>incidence: Daily new occurence of COVID-19</li>
<li>deaths: Total recorded deaths cases</li>
<li>daily_deaths: Daily incidence of death occurence</li>
<li>recovered: Total recovered cases</li>
<li>daily_recovery: Daily case of recovery</li>
<li>active_cases: Number of active cases</li>
<li>closed_cases: Number of closed cases (death/recovered)</li>
<li>death_rate: percentage of deaths among total cases (in %)</li>
<li>recovery_rate: percentage of recovery among total cases (in %)</li>
</ul>

<br>
```{r}
datatable(covid_id[c(-1)], options = list(pageLength = 7), rownames = FALSE)
```

<br>
**(2020/04/03)** Deaths rate in Indonesia is considered high compared to other countries, with the number almost hit 10%. The fact that death is larger than recovery, it's a something to look at. For instance, Australia has three times larger for confirmed total cases, yet the deaths in Australia is only 0.51%, compared to Indonesia's 9.5%. This might occurs due to some factors, for example, inability to handle this pandemic, limited health care system, & lack of resources and awareness. More people died rather than recovered from this case.

## Graphs

```{r}
p_case <- covid_id[c(2:3,9:10)] %>% gather(key="Case", value = "no_of_cases", -date) %>% ggplot(aes(x=date,y=no_of_cases,color=Case)) +
  geom_point() + geom_line() + scale_color_discrete(labels = c("Active Cases","Closed Cases","Confirmed Total Cases")) + 
  labs(y="No of Cases", x="Date", title="Confirmed Cases")
ggplotly(p_case)

#covid_id %>% ggplot(aes(x=date, y=total_cases)) + geom_line() + geom_point() + geom_line(data=covid_id, aes(y=active_cases), color="red") +geom_point(data=covid_id, aes(y=active_cases), color="red") +geom_line(data=covid_id, aes(y=closed_cases), color="blue") + geom_point(data=covid_id, aes(y=closed_cases), color="blue") +labs(y="No of Cases", x="Date")

#covid_id[c(2:3,9:10)] %>% gather(key="case", value = "no_of_cases", -date) %>% ggplot(aes(x=date,y=no_of_cases,color=case)) +geom_point() +geom_line() + scale_color_discrete(labels = c("Active Cases","Closed Cases","Confirmed Total Caases")) +labs(y="No of Cases", x="Date")
```

```{r}
covid_id[c(2,5,7,10)] %>% gather(key = "Deaths/Recovered", value = "count", -date, -closed_cases) -> cvd_close

cvd_close %>%
  ggplot(aes(x=date,y=count,fill=`Deaths/Recovered`)) + geom_col(data=cvd_close, aes(x=date,y=closed_cases), fill="black",position="identity", alpha=0.25) + geom_col(position = "dodge") + labs(y="Closed Cases", x="Date", title="Total Closed Cases") -> p_close
ggplotly(p_close)
```

```{r}
#covid_id[c(2,6,8)] %>% gather(key="Daily Cases", value="count", -date) -> cvd_inc
#cvd_inc %>% ggplot(aes(x=date,y=count, fill=`Daily Cases`)) + geom_col(position="stack")

ggplotly(covid_id %>% ggplot(aes(x=date, y=incidence)) + geom_col(fill="#868180") + labs(x="Date", y="New Cases", title="Daily Incidence"))
ggplotly(covid_id %>% ggplot(aes(x=date, y=daily_deaths)) + geom_col(fill="#FF6A58") + labs(x="Date", y="New Deaths Cases", title="Daily Deaths"))
ggplotly(covid_id %>% ggplot(aes(x=date, y=daily_recovery)) + geom_col(fill="lightblue") + labs(x="Date", y="New Recovered Cases", title="Daily Recovered"))
```

<br>


## Prediction Model

```{r}
covid_mdata <- covid_id %>% mutate(days=row_number())
```

```{r, eval=FALSE}
rmse1 <- NULL
tfit <- NULL
pol <- c(1:10)

for (i in length(pol)) {
  glm(total~poly(days, pol[i]), data = covid_mdata, family = poisson) -> tmod
  augment(tmod, covid_mdata) -> tmod_aug
  tmodm <- sum(tmod_aug$.resid^2)/length(tmod_aug$.resid)
  rmse2 <- c(rmse1, tmodm)
}

# Fit a loess model and compute MSEs
for (i in 1:length(span)) 
  {
  fit2 <- loess(y ~ x, data=tr, span=span[i])
  tr_aug2 <- augment(fit2, tr)
  trm <- sum(tr_aug2$.resid^2)/length(tr_aug2$.resid)
  tr_mse2 <- c(tr_mse2, trm)
}

```


```{r}
mod1 <- glm(total~poly(days, 7), data = covid_mdata, family = poisson)

cov_id_fit <- covid_id[,c(2:3)] %>% mutate(fit1=mod1$fitted.values) %>% rename("actual"='total')


mod2 <- loess(total~days, span = 0.15, data=covid_mdata)

cov_id_fit <- cov_id_fit %>% mutate(fit2=mod2$fitted)


mod3 <- gam(total~s(days), data=covid_mdata)

cov_id_fit <- cov_id_fit %>% mutate(fit3=mod3$fitted.values)
```


```{r, eval=FALSE}
rmse(cov_id_fit$actual,cov_id_fit$fit1)
rmse(cov_id_fit$actual,cov_id_fit$fit2)
rmse(cov_id_fit$actual,cov_id_fit$fit3) #we chose this
cov_id_fit %>% gather(key = "fit", value = "value", -date) -> fit_long
fit_long %>% ggplot(aes(x=date,y=value,color=fit)) + geom_line()
```

Future Prediction
```{r}
data.frame(date=seq(as.Date(first(covid_mdata$date)), as.Date(today_case$date+1), by="days")) %>% mutate(days=row_number()) -> pred_tmr


predict(mod3, newdata=pred_tmr %>% filter(date==last(date)), type="response") -> tomorrow

#sprintf("Tomorrow predicted case is %.2f", tomorrow)

pander(data.frame(`Date`=today_case$date+1, `Predicted Value`=tomorrow, 
                  `Upper Confidence`=tomorrow+sd(cov_id_fit$fit3)/length(cov_id_fit$fit3)*qt(0.95,length(cov_id_fit$fit3)),
                  `Lower Confidence`=tomorrow+sd(cov_id_fit$fit3)/length(cov_id_fit$fit3)*qt(0.05,length(cov_id_fit$fit3))))
```
<br>
<br>
Today's prediction vs actual values
```{r}
pander(cov_id_fit %>% filter(date==last(date)) %>% select(date,actual,fit3) %>% rename("Date"='date', `Actual`='actual', `Predicted`='fit3'))
```
<br>


```{r}
cov_id_fit %>% ggplot(aes(x=date,y=actual)) + geom_line() + geom_line(data = cov_id_fit,aes(x=date,y=cov_id_fit$fit3), color="orange") + labs(x="Date",y="No of Cases", title="Actual Value (black) vs Predicted Value (orange)")
```

